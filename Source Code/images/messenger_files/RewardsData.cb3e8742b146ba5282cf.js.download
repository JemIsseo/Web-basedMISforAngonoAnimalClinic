(self.webpackChunk_msnews_msnews_experiences=self.webpackChunk_msnews_msnews_experiences||[]).push([["RewardsData"],{76373:function(e,t,r){"use strict";var s,i,n;r.d(t,{Ck:function(){return f},H8:function(){return o},I8:function(){return d},MW:function(){return a},OF:function(){return n},Zp:function(){return p},be:function(){return s},s8:function(){return c}}),function(e){e.SetEdgeAsDefault="9",e.SetEdgeAsDefaultV2="rewards_anaheim_install",e.EdgeNTP_NewsDailySet_Child1="EdgeNTP_NewsDailySet_Child1",e.EdgeNTP_NewsDailySet_Child2="EdgeNTP_NewsDailySet_Child2",e.EdgeNTP_NewsDailySet_Child3="EdgeNTP_NewsDailySet_Child3",e.ENUS_infomode_switch_keep_s1_100="ENUS_infomode_switch_keep_s1_100",e.ENUS_infomode_switch_keep_s2_400="ENUS_infomode_switch_keep_s2_400",e.ENUS_infomode_keep_disqualification="ENUS_infomode_keep_disqualification",e.ENUS_readarticle10_100points="ENUS_readarticle10_100points",e.ENUS_readarticle5_50points="ENUS_readarticle5_50points",e.ENUS_readarticle3_30points="ENUS_readarticle3_30points",e.ENUS_sharearticle5_20points="ENUS_sharearticle5_20points",e.ENUS_sharearticle10_40points="ENUS_sharearticle10_40points",e.ENUS_sharearticle20_80points="ENUS_sharearticle20_80points",e.BackupPayment="ENUS_readandearn_backup_payment"}(s||(s={})),function(e){e.TopicDataActions="TopicDataActions",e.LayoutActions="LayoutActions"}(i||(i={})),function(e){e.TryInformationalMode="TryInformationalMode",e.SetEdgeAsDefault="SetEdgeAsDefault"}(n||(n={}));const a="SwitchPageLayout",o="NTP_CourtesyEngineCampaign",c="RDC_OfferMessageSuppressed",d=new Map;d.set(s.SetEdgeAsDefault,!1),d.set(s.SetEdgeAsDefaultV2,!1),d.set(s.ENUS_infomode_switch_keep_s1_100,!1);const f=new Map,g={experienceConnector:i.LayoutActions,actionName:n.TryInformationalMode,requiredCount:1,observedActivityCount:0},u={activities:[{experienceConnector:i.LayoutActions,actionName:n.SetEdgeAsDefault,requiredCount:1,observedActivityCount:0}],isRewardActivityComplete:!1,isOfferReported:!1},l={activities:[g],isRewardActivityComplete:!1,isOfferReported:!1,isLocalMessage:!0,isLocalFollowOnMessage:!0};f.set(s.SetEdgeAsDefault,[u]),f.set(s.SetEdgeAsDefaultV2,[u]),f.set(s.ENUS_infomode_switch_keep_s1_100,[l]);const p="rewards_completion_coachmark_offers"},37577:function(e,t,r){"use strict";r.r(t),r.d(t,{ActionName:function(){return s.OF},IrisHandler:function(){return u},OfferId:function(){return s.be},RewardsDataActions:function(){return p},RewardsDataConnector:function(){return I},RewardsDataReducer:function(){return T},RewardsServiceClient:function(){return E.H},ToolingInfo:function(){return N},mockConfig:function(){return D.mockConfig}});var s=r(76373),i=r(33940),n=r(73231),a=r(91881),o=r(26415),c=r(33954),d=r(53076),f=r(93450),g=r(65135);class u{static getRewardsFromDataConnector(){return(0,i.mG)(this,void 0,void 0,(function*(){const e=yield f._.getInstance().rootReducer.getDataConnector(d.z.IrisData);if(!e)return g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.IrisDataConnectorUndefined),{message:"No Iris data connector"})),null;const t=yield e.getPayload(a._l.MSNNewsCoachmark);return this.extractRewardsCreativeMessages(t)}))}static extractRewardsCreativeMessages(e){if(!e)return c.k.log(`IrisHandler: Iris surface not found for the campaign: ${e}`),null;const t=new Map;let r;return e.creatives.forEach((s=>{var i;const a=[];s.content&&s.content.cm&&s.content.rewards&&s.telemetry&&(s.content.cm.forEach((t=>{r=Object.assign(Object.assign({},t),{coachmarkSource:n.jX.Iris,creativeId:s.creativeId,ctaList:t.cta,ecsFeatureFlags:s.content.ecsFeatureFlags,eventUrl:s.telemetry,frequency:Number(s.content.frequency),frequencyInterval:Number(s.content.frequencyInterval),isEcsExperiment:"true"===s.content.isEcsExperiment,placementId:e.placement,rewardsInfo:s.content.rewards,showPointer:!("true"===t.disablePointer),timeoutInMs:Number(t.timeoutInMs)}),a.push(r)})),t.set(null!==(i=s.content.rewards.activityId)&&void 0!==i?i:s.content.rewards.offerId,a))})),t}}var l=r(55067);class p{}p.setIsRewardsUser=new l.C("SetIsRewardsUser"),p.setRewardPoints=new l.C("SetRewardPoints"),p.setUnclaimedRewardPoints=new l.C("SetUnclaimedRewardPoints"),p.setRewardsOffers=new l.C("SetRewardsOffer"),p.setRewardsTokens=new l.C("SetRewardsTokens"),p.setRewardsEligibility=new l.C("SetRewardsEligibility");var h=r(51167),m=r(33799),w=r(7009),v=r(9500),b=r(84169),O=r(35385),S=r(53899),E=r(44327),y=r(17440);function _(){return(0,i.mG)(this,void 0,void 0,(function*(){return yield y.U.isApiAvailableToUse(),y.U.getPreferenceSetting(s.Zp,!0).then((e=>{if(!e||!e.value||!e.value.length)return[];return e.value})).catch((e=>{c.k.logError(`Exception ${e} occurred when accessing ${s.Zp} in PSL`)}))}))}function R(e){return(0,i.mG)(this,void 0,void 0,(function*(){if(e)return yield y.U.isApiAvailableToUse(),y.U.savePreferenceSetting(s.Zp,e).then((e=>e)).catch((e=>(c.k.logError(`Exception ${e} occurred when saving ${s.Zp} in PSL`),!1)))}))}function k(e){return(0,i.mG)(this,void 0,void 0,(function*(){const t=yield _();!function(e,t){if(!e)return;const r=e.findIndex((e=>e.offerId===t.offerId));-1!==r?e[r]=t:e.push(t)}(t,e),R(t)}))}var C=r(63439),P=r(82209),A=r(90351),M=r(65932),U=r(51671);class I extends C.e{constructor(e,t,r,n,a,c,d){super(e,t,r,n,a,c,d),this.signInStatus=m.Hy.Unknown,this.offerPlacedOnUserScreen=void 0,this.activityTrackerMap=void 0,this.bingRewardsOfferStatusMap=void 0,this.rewardsServiceClient=new E.H(c.endpointV2),this.offerMap=new Map,this.offerPlacedOnUserScreen=s.I8,this.activityTrackerMap=s.Ck,this.bingRewardsOfferStatusMap=new Map,c.enableRewardsOffers&&("windowsShell"!==b.jG.AppType?(0,U.rr)().then((e=>{this.signInStatus=e,(e===m.Hy.SignedIn||this.config.endpointV2)&&this.fetchUserProfile().then((()=>(0,i.mG)(this,void 0,void 0,(function*(){this.getCurrentState().isRewardsUser&&(this.setOffersInState(),this.setEligibilityInState(),this.setTokensInState(),this.registerObservers(),yield this.getRewardsOfferMap(),this.syncActivityTrackerMapWithIrisOffers(),yield this.getCoachmarkDataConnector(),yield this.getChromiumPageSettingsConnector(),this.renderOfferMessage(),this.config.enableLocalCoachmarks&&this.getRewardsCoachmarkDataConnector().then((()=>{this.rewardsCoachmarkDataConnector?(this.rewardsCoachmarkDataConnector.addRewardsCoachmarks(this.bingRewardsOffers),this.config.showMissedCompletionCoachmark&&this.checkAndShowMissedCompletionCoachmarks()):g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.RewardsCoachmarkConnectorUndefined),{message:"RewardsCoachmarkDataConnector is not defined"}))})),this.checkTimePeriodOfferStatus())}))))})):this.fetchUserProfile())}fetchUserProfile(e=!1){return(0,i.mG)(this,void 0,void 0,(function*(){if(this.rewardsUserProfileResponse=yield this.rewardsServiceClient.getRewardsUserProfile(this.signInStatus,e),!this.rewardsUserProfileResponse||!this.rewardsUserProfileResponse.response)return;const t=(0,A.Z)(this.rewardsUserProfileResponse.response,"profile.points",void 0),r=null!=t;p.setIsRewardsUser.getActionSender(this).send(r),r&&p.setRewardPoints.getActionSender(this).send(t);const s=(0,A.Z)(this.rewardsUserProfileResponse.response,"offers",void 0);s&&(s.forEach((e=>{this.config.endpointV2?this.bingRewardsOfferStatusMap.set(e.offerId,{activityType:e.activityType,isComplete:"True"===e.isComplete,progress:e.progress||0,points:e.points||0,maxPoints:e.maxPoints,offerId:e.offerId,completionDate:e.completionDate?new Date(e.completionDate):null}):this.bingRewardsOfferStatusMap.set(e.offerId,{activityType:e.offerId,isComplete:"True"===e.isComplete,progress:e.progress||0,points:e.points||0,maxPoints:e.maxPoints,offerId:e.offerId})})),this.bingRewardsOffers=s)}))}registerObservers(){O.J.updateLayout.registerObserver((e=>{const t=e&&e.params;!t||t.length<1||t[0].currentLayout!=S.nP.informational&&"always"!==t[0].selectedFeedDisplaySetting&&this.checkEligibilityInformationalSwitchOffer()})),document.addEventListener("changeToInformationalSuccess",(e=>{this.trackRewardActions(s.be.ENUS_infomode_switch_keep_s1_100,s.MW)})),document.addEventListener("setDefaultBrowserSuccess",(e=>{this.config.endpointV2?this.trackRewardActions(s.be.SetEdgeAsDefaultV2,s.OF.SetEdgeAsDefault,!1):this.trackRewardActions(s.be.SetEdgeAsDefault,s.OF.SetEdgeAsDefault,!1)})),(0,M.Uo)(d.z.RewardsCoachmarkData,(e=>{var t;(null===(t=null==e?void 0:e.activeCoachmark)||void 0===t?void 0:t.offerId)&&this.offerPlacedOnUserScreen.has(e.activeCoachmark.offerId)&&this.offerPlacedOnUserScreen.set(e.activeCoachmark.offerId,!0)}))}reportRewardsAction(e,t=!1){var r;return(0,i.mG)(this,void 0,void 0,(function*(){if(!e)return void g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.OfferIdNotDefined),{message:"OfferId is not defined"}));if(this.isOfferDisabled(e))return;if(!(null===(r=this.config)||void 0===r?void 0:r.reportingActivityEndpointV2))return void g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.VersionNotSupported),{message:"Only version 2 end point is supported"}));const s=this.getCurrentState().rewardsOffers;if(!s||!s.length)return;const i=s.find((t=>t.offerId===e));if(!i||i.isComplete)return;this.checkAndStampForActivityReporting(e);const n=yield this.rewardsServiceClient.reportMsRewardsActivityV2(i.offerId,i.activityType,t);yield this.fetchUserProfileToGetOffersWithRetry(e,null==n?void 0:n.debugId,void 0,(()=>{this.setOffersInState()}))}))}createRewardsProfile(e,t){return(0,i.mG)(this,void 0,void 0,(function*(){return yield this.rewardsServiceClient.createRewardsProfile(e,t)}))}trackRewardActions(e,t,r=!0){return(0,i.mG)(this,void 0,void 0,(function*(){if(!e)return void g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.OfferIdNotDefined),{message:"OfferId is not defined"}));if(!t)return void g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.ActionNameNotDefined),{message:"Action name is not defined"}));const s=this.activityTrackerMap.get(e);s&&this.bingRewardsOfferStatusMap.has(e)&&!this.bingRewardsOfferStatusMap.get(e).isComplete&&(this.offerPlacedOnUserScreen.has(e)&&!this.offerPlacedOnUserScreen.get(e)||s.forEach((s=>(0,i.mG)(this,void 0,void 0,(function*(){var i;if(!s.isRewardActivityComplete){let e=!0;s.activities.forEach((t=>{let r=!1;++t.observedActivityCount>=t.requiredCount&&(r=!0),e=e&&r})),s.isRewardActivityComplete=e}if(!s.isOfferReported&&s.isRewardActivityComplete){this.checkAndStampForActivityReporting(e);let n="";if(this.config.reportingActivityEndpointV2){const t=yield this.rewardsServiceClient.reportMsRewardsActivityV2(e,this.bingRewardsOfferStatusMap.get(e).activityType);s.isOfferReported=t.success,n=t.debugId}else s.isOfferReported=yield this.rewardsServiceClient.reportMsRewardsActivity(this.signInStatus,t,null===(i=this.bingRewardsOfferStatusMap.get(e).activityType)||void 0===i?void 0:i.toString());r&&this.renderFollowOnMessage(s,e,n)}})))))}))}renderFollowOnMessage(e,t,r=""){return(0,i.mG)(this,void 0,void 0,(function*(){e.isOfferReported&&this.renderFollowOnMessageForOffer(t,e.isLocalFollowOnMessage,r)}))}renderFollowOnMessageForOffer(e,t=!1,r=""){return(0,i.mG)(this,void 0,void 0,(function*(){this.fetchUserProfileToGetOffersWithRetry(e,r,t,((e,t)=>{if(t)this.rewardsCoachmarkDataConnector&&this.rewardsCoachmarkDataConnector.addFollowOnCoachmarksForOffer(e);else{const t=this.offerMap.has(e)&&this.offerMap.get(e),r=t&&t.length>1&&t[1];r&&this.coachmarkDataConnector.addCoachmark([r])}}))}))}getRewardsOfferMap(){return(0,i.mG)(this,void 0,void 0,(function*(){const e=yield u.getRewardsFromDataConnector();e&&0!==e.size&&e.forEach(((e,t)=>{this.offerMap.has(t)||this.offerMap.set(t,e)}))}))}syncActivityTrackerMapWithIrisOffers(){this.activityTrackerMap.forEach(((e,t)=>{(!e.some((e=>e.isLocalMessage))&&!this.offerMap.has(t)||this.isOfferDisabled(t))&&this.activityTrackerMap.delete(t)}))}getCoachmarkDataConnector(){return(0,i.mG)(this,void 0,void 0,(function*(){const e=yield f._.getInstance().rootReducer.getDataConnector(d.z.CoachmarkData);e?this.coachmarkDataConnector=e:g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.CoachmarkDataConnectorUndefined),{message:"Coachmark data connector is undefined"}))}))}getChromiumPageSettingsConnector(){return(0,i.mG)(this,void 0,void 0,(function*(){const e=yield f._.getInstance().rootReducer.getDataConnector(d.z.ChromiumPageSettings);this.chromiumPageSettingsConnector=e}))}getRewardsCoachmarkDataConnector(){return(0,i.mG)(this,void 0,void 0,(function*(){const e=yield f._.getInstance().rootReducer.getDataConnector(d.z.RewardsCoachmarkData);this.rewardsCoachmarkDataConnector=e}))}renderOfferMessage(){var e,t,r,n,a,c;return(0,i.mG)(this,void 0,void 0,(function*(){const d=null===(e=this.chromiumPageSettingsConnector)||void 0===e?void 0:e.getCurrentState();d&&d.currentLayout&&(null===(r=null===(t=null==d?void 0:d.configData)||void 0===t?void 0:t.irisAttributes)||void 0===r?void 0:r.get("ADEFAB"))||g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.PageSettingsUndefined),{message:"PageSettings or currentLayout/browserType not defined"}));const f=w.Aq[null===(a=null===(n=null==d?void 0:d.configData)||void 0===n?void 0:n.irisAttributes)||void 0===a?void 0:a.get("ADEFAB")],u=w.Aq[w.Aq.MSEDGE],l=!d||!d.configData||!(null===(c=d.configData.irisAttributes)||void 0===c?void 0:c.get("ADEFAB"))||f==u;let p=this.config.offersPerSession;this.offerMap.forEach(((e,t)=>(0,i.mG)(this,void 0,void 0,(function*(){var r,i;if((t!==s.be.SetEdgeAsDefault&&t!==s.be.SetEdgeAsDefaultV2||!l)&&this.offerPlacedOnUserScreen.has(t)&&!this.offerPlacedOnUserScreen.get(t)&&p>0){if(t===s.be.SetEdgeAsDefault||t===s.be.SetEdgeAsDefaultV2){const n=+(null===(i=null===(r=null===b.jG||void 0===b.jG?void 0:b.jG.CurrentRequestTargetScope)||void 0===r?void 0:r.browser)||void 0===i?void 0:i.version);if(n&&!isNaN(n)&&n>=104){const r=yield P.M.getToken(s.H8);if(void 0===(null==r?void 0:r.success))g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.jhM),{message:`Edge nurturing API not available when trying to confirm eligibility for default_browser_rewards_offer. ${r?r.Message:""}`}));else{if(!r.success)return void g.M0.addOrUpdateTmplProperty(s.s8+"_"+t,"1");e[0].edgeNurturingAPICampaignName=s.H8}}}const n={name:t};if(!v.i.getInstance().register(n))return;yield this.delay(this.config.delayLoadOfferInMs);const a=this.config.tmplOffers;if(a&&a[t]&&a[t].enabledTMPL){let e="";e=a[t].tmplString?a[t].tmplString:`UserEligibleForOffer_${t}`,g.M0.addOrUpdateTmplProperty(e,"1")}if(this.isOfferDisabled(t))return;const c=yield this.coachmarkDataConnector.addCoachmark([e[0]]);c&&(this.offerPlacedOnUserScreen.set(t,c),p--)}}))))}))}delay(e){return(0,i.mG)(this,void 0,void 0,(function*(){return new Promise((t=>window.setTimeout(t,e)))}))}setTokensInState(){this.rewardsUserProfileResponse&&this.rewardsUserProfileResponse.response&&p.setRewardsTokens.getActionSender(this).send(this.rewardsUserProfileResponse.response.tokens||[])}setEligibilityInState(){this.rewardsUserProfileResponse&&this.rewardsUserProfileResponse.response&&p.setRewardsEligibility.getActionSender(this).send({backupPayment:this.rewardsUserProfileResponse.response.eligibleBackupPayment||!1,freeTipping:this.rewardsUserProfileResponse.response.eligibleFreeTipping||!1,freeSubscription:this.rewardsUserProfileResponse.response.eligibleFreeSubscription,autoOpen:"edgeChromium"===b.jG.AppType&&this.rewardsUserProfileResponse.response.auto_open||!1})}setOffersInState(){let e;e="views"==b.jG.AppType?[s.be.ENUS_readarticle3_30points,s.be.ENUS_readarticle5_50points,s.be.ENUS_readarticle10_100points,s.be.ENUS_sharearticle5_20points,s.be.ENUS_sharearticle10_40points,s.be.ENUS_sharearticle20_80points,s.be.BackupPayment]:[s.be.EdgeNTP_NewsDailySet_Child1,s.be.EdgeNTP_NewsDailySet_Child2,s.be.EdgeNTP_NewsDailySet_Child3,s.be.ENUS_infomode_switch_keep_s2_400];const t=[];e.forEach((e=>{this.bingRewardsOfferStatusMap.has(e)&&t.push(this.bingRewardsOfferStatusMap.get(e))})),0!=t.length&&p.setRewardsOffers.getActionSender(this).send(t)}isOfferDisabled(e){const t=this.config.disableOffers;return t&&t[e]&&t[e].disable}checkEligibilityInformationalSwitchOffer(){if(this.isOfferDisabled(s.be.ENUS_infomode_keep_disqualification)||!this.bingRewardsOfferStatusMap.has(s.be.ENUS_infomode_keep_disqualification)||this.bingRewardsOfferStatusMap.get(s.be.ENUS_infomode_keep_disqualification).isComplete)return;if(!this.bingRewardsOfferStatusMap.has(s.be.ENUS_infomode_switch_keep_s1_100))return;const e=this.bingRewardsOfferStatusMap.get(s.be.ENUS_infomode_switch_keep_s1_100);!e.isComplete||!e.completionDate||Date.now()-e.completionDate.getTime()>6048e5||(this.checkAndStampForActivityReporting(s.be.ENUS_infomode_keep_disqualification),this.rewardsServiceClient.reportMsRewardsActivityV2(s.be.ENUS_infomode_keep_disqualification,this.bingRewardsOfferStatusMap.get(s.be.ENUS_infomode_keep_disqualification).activityType))}checkTimePeriodOfferStatus(){var e;if(!this.bingRewardsOfferStatusMap.has(s.be.ENUS_infomode_switch_keep_s2_400)||this.bingRewardsOfferStatusMap.get(s.be.ENUS_infomode_switch_keep_s2_400).isComplete||this.isOfferDisabled(s.be.ENUS_infomode_switch_keep_s2_400))return;if(!this.bingRewardsOfferStatusMap.has(s.be.ENUS_infomode_switch_keep_s1_100))return;const t=this.bingRewardsOfferStatusMap.get(s.be.ENUS_infomode_switch_keep_s1_100);if(!t||!t.isComplete||!t.completionDate)return;const r=t.completionDate.getTime();if(!r||Date.now()-r<=6048e5||r<new Date("10/24/2022 UTC").getTime())return;const i=null===(e=this.chromiumPageSettingsConnector)||void 0===e?void 0:e.getCurrentState();i&&i.currentLayout?i.currentLayout!==S.nP.informational&&"always"!==i.selectedFeedDisplaySetting||this.reportRewardsAction(s.be.ENUS_infomode_switch_keep_s2_400).then((()=>{this.bingRewardsOfferStatusMap.has(s.be.ENUS_infomode_switch_keep_s2_400)&&this.bingRewardsOfferStatusMap.get(s.be.ENUS_infomode_switch_keep_s2_400).isComplete&&this.rewardsCoachmarkDataConnector&&this.rewardsCoachmarkDataConnector.addFollowOnCoachmarksForOffer(s.be.ENUS_infomode_switch_keep_s2_400)})):g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.PageSettingsUndefined),{message:"PageSettings or currentLayout not defined"}))}checkAndStampForActivityReporting(e){if(!e)return;const t=this.config.tmplReportingActivityOffers;if(t&&t[e]&&t[e].enabledTMPL){let r="";r=t[e].tmplString?t[e].tmplString:`UserReportingRewardsActivityForOffer_${e}`,g.M0.addOrUpdateTmplProperty(r,"1")}}fetchUserProfileToGetOffersWithRetry(e,t="",r=!1,s){return(0,i.mG)(this,void 0,void 0,(function*(){let i=!0,n=0;let a=this.config.delayGetUserProfileCallInMs?this.config.delayGetUserProfileCallInMs:500,c=!1;for(;i&&n<5;n++)yield this.delay(a),!c&&n>3&&this.config.allowRetryWithAltDomain&&(c=!0),yield this.fetchUserProfile(c),this.bingRewardsOfferStatusMap.has(e)&&this.bingRewardsOfferStatusMap.get(e).isComplete&&(i=!1,s(e,r)),a*=2;if(i){if(this.config.showMissedCompletionCoachmark){k({offerId:e,isCoachmarkShown:!1,offerReportTimestamp:Date.now()})}g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.MaxRetryReachedForUpdatingRewardsPoints),{message:"Max retry attempt reached to update rewards points on user screen",pb:Object.assign(Object.assign({},o.Ytw.MaxRetryReachedForUpdatingRewardsPoints.pb),{customMessage:`Attempted ${n} times but user's reward points were not updated for Offer Id : ${e}`,debugId:t,rewardsUserProfileResponse:JSON.stringify(this.rewardsUserProfileResponse)})}))}}))}checkAndShowMissedCompletionCoachmarks(){return(0,i.mG)(this,void 0,void 0,(function*(){if(!this.config||!this.config.completionCoachmarkOffers)return;let e=yield _();if(e&&e.length&&(e=e.filter((e=>{if(e.isCoachmarkShown||!e.offerId)return!1;{const t=this.config.completionCoachmarkOffers[e.offerId];return!(!t||!t.enabled)&&!(t.maxEligibleTimeInHours&&(!e.offerReportTimestamp||e.offerReportTimestamp+6e4*t.maxEligibleTimeInHours*60<Date.now()))}})),R(e),e&&e.length&&this.rewardsCoachmarkDataConnector))for(let t=0;t<e.length;t++){if(this.bingRewardsOfferStatusMap.has(e[t].offerId)&&this.bingRewardsOfferStatusMap.get(e[t].offerId).isComplete){if(g.M0.addOrUpdateTmplProperty("show_missed_completion_coachmarks","1"),this.config.isControl){this.getDisplayCallbackForOffer(e[t].offerId)()}else this.rewardsCoachmarkDataConnector.addFollowOnCoachmarksForOffer(e[t].offerId,this.getDisplayCallbackForOffer(e[t].offerId));break}g.M0.sendAppErrorEvent(Object.assign(Object.assign({},o.Ytw.IncompleteOfferError),{message:"Rewards offer not completed since last attempt to report activity",pb:Object.assign(Object.assign({},o.Ytw.IncompleteOfferError.pb),{customMessage:`Offer not completed. Offer Id : ${e[t].offerId}, Reporting timestamp: ${e[t].offerReportTimestamp}`})}))}}))}getDisplayCallbackForOffer(e){return()=>{k({offerId:e,isCoachmarkShown:!0,offerReportTimestamp:Date.now()})}}}var j=r(30856);class T{reduce(e,t){if(!e)return{isRewardsUser:void 0,rewardPoints:void 0,unclaimedRewardPoints:void 0,rewardsOffers:void 0,rewardsTokens:void 0,rewardsEligibility:void 0};if(!t)return e;let r,s=!1;return s=s||j.G.handleAction(t,p.setIsRewardsUser,(t=>{r=Object.assign(Object.assign({},e),{isRewardsUser:t})})),s=s||j.G.handleAction(t,p.setRewardPoints,(t=>{r=Object.assign(Object.assign({},e),{rewardPoints:t})})),s=s||j.G.handleAction(t,p.setUnclaimedRewardPoints,(t=>{r=Object.assign(Object.assign({},e),{unclaimedRewardPoints:t})})),s=s||j.G.handleAction(t,p.setRewardsOffers,(t=>{r=Object.assign(Object.assign({},e),{rewardsOffers:t})})),s=s||j.G.handleAction(t,p.setRewardsTokens,(t=>{r=Object.assign(Object.assign({},e),{rewardsTokens:t})})),s=s||j.G.handleAction(t,p.setRewardsEligibility,(t=>{r=Object.assign(Object.assign({},e),{rewardsEligibility:t})})),r||e}}var D=r(94842);const N={experienceConfigSchema:h.RewardsDataConfigSchema,mockConfig:D.mockConfig,defaultMockState:{},mockState:[{key:"preview",value:{}}]}},44327:function(e,t,r){"use strict";r.d(t,{H:function(){return g}});var s=r(33940),i=r(84169),n=r(19809),a=r(63535),o=r(87298),c=r(26415),d=r(33799),f=r(65135);class g{constructor(e=!1){this.endpointV2=e,this.fetchRewardsProfileServiceEndpoint="./News/Users/me/Rewards",this.reportRewardsActivityServiceEndpoint="./News/Users/me/RewardsActivities",this.ocid="rewards-peregrine",this.eventType="Default"}getRewardsUserProfile(e,t=!1){var r;return(0,s.mG)(this,void 0,void 0,(function*(){if(e!==d.Hy.SignedIn&&!this.endpointV2)return null;const g={method:"GET",credentials:"include",cache:"no-cache",headers:yield n.$.getOneServiceHeaders()};let u;u=t?(0,a.PH)(this.fetchRewardsProfileServiceEndpoint,a.Ph):(0,a.PH)(this.fetchRewardsProfileServiceEndpoint);[...n.$.getOneServiceParamsWithAuth((0,i.Yq)().UserId,this.ocid)].forEach((e=>{e.value&&u.searchParams.set(e.key,e.value)})),this.endpointV2&&u.searchParams.set("version","2");try{const e=yield(0,o.w)((()=>(0,s.mG)(this,void 0,void 0,(function*(){const e=yield fetch(u.href,g);return 404===e.status?{}:e.ok?e.json():(400===e.status?f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.InvalidParameters),{message:"Bad request on account of invalid parameters",pb:Object.assign(Object.assign({},c.Ytw.InvalidParameters.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(g)} Service url: ${u.href}`})})):500===e.status?f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.ErrorFetchingUserProfile),{message:"Error fetching user profile",pb:Object.assign(Object.assign({},c.Ytw.ErrorFetchingUserProfile.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(g)} Service url: ${u.href}`})})):f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.UnknownErrorOccurred),{message:"Unknown error occurred while fetching user profile",pb:Object.assign(Object.assign({},c.Ytw.UnknownErrorOccurred.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(g)} Service url: ${u.href}`})})),null)}))),"getUserProfileResponse");return{response:e,debugId:null===(r=null==e?void 0:e.headers)||void 0===r?void 0:r.get("ddd-debugid")}}catch(e){return f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.ExceptionFetchingUserProfile),{message:"Exception during user profile service call",pb:Object.assign(Object.assign({},c.Ytw.ExceptionFetchingUserProfile.pb),{customMessage:`Error code: ${e?e.code:"undefined"} Error message: ${e?e.message:"undefined"}\n                        Request params: ${JSON.stringify(g)} Service url: ${u.href}`})})),null}}))}createRewardsProfile(e=null,t=null){return(0,s.mG)(this,void 0,void 0,(function*(){const r={method:"POST",credentials:"include",cache:"no-cache",headers:yield n.$.getOneServiceHeaders()},d=(0,a.PH)(this.fetchRewardsProfileServiceEndpoint);d.searchParams.set("fdhead","prg-1s-acclnk-puid");[...n.$.getOneServiceParamsWithAuth((0,i.Yq)().UserId,this.ocid)].forEach((e=>{e.value&&d.searchParams.set(e.key,e.value)})),e&&d.searchParams.set("crea",e),t&&d.searchParams.set("program",t),this.endpointV2&&d.searchParams.set("version","2");try{yield(0,o.w)((()=>(0,s.mG)(this,void 0,void 0,(function*(){const e=yield fetch(d.href,r);return!!e.ok||(400===e.status?f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.InvalidParameters),{message:"Bad request on account of invalid parameters",pb:Object.assign(Object.assign({},c.Ytw.InvalidParameters.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(r)} Service url: ${d.href}`})})):500===e.status?f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.ErrorFetchingUserProfile),{message:"Error creating user profile",pb:Object.assign(Object.assign({},c.Ytw.ErrorFetchingUserProfile.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(r)} Service url: ${d.href}`})})):f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.UnknownErrorOccurred),{message:"Unknown error occurred while fetching user profile",pb:Object.assign(Object.assign({},c.Ytw.UnknownErrorOccurred.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(r)} Service url: ${d.href}`})})),!1)}))),"createProfileResponse");return!0}catch(e){return f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.ExceptionFetchingUserProfile),{message:"Exception during create user profile service call",pb:Object.assign(Object.assign({},c.Ytw.ExceptionFetchingUserProfile.pb),{customMessage:`Error code: ${e?e.code:"undefined"} Error message: ${e?e.message:"undefined"}\n                        Request params: ${JSON.stringify(r)} Service url: ${d.href}`})})),!1}}))}reportMsRewardsActivity(e,t,r,g){return(0,s.mG)(this,void 0,void 0,(function*(){if(e!==d.Hy.SignedIn)return null;const u=new Date,l=(0,i.Yq)(),p={method:"POST",body:JSON.stringify({activityId:l.ActivityId,eventType:t,dateTime:u.toISOString(),timezoneOffset:this.getDateTimezoneOffSet(u),market:l.CurrentMarket,offerId:r,pageType:l.TrackInfo&&l.TrackInfo.sitePage&&l.TrackInfo.sitePage.page_type,product:l.TrackInfo&&l.TrackInfo.sitePage&&l.TrackInfo.sitePage.page_product,eventContext:g}),headers:yield n.$.getOneServiceHeaders(),credentials:"include"},h=(0,a.PH)(this.reportRewardsActivityServiceEndpoint);[...n.$.getOneServiceParamsWithAuth(l.UserId,this.ocid)].forEach((e=>{e.value&&h.searchParams.set(e.key,e.value)}));try{return!!(yield(0,o.w)((()=>(0,s.mG)(this,void 0,void 0,(function*(){const e=yield fetch(h.href,p);return e.ok?e.json():(400===e.status?f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.BadRequestReportingRewardActivity),{message:"Bad request when reporting rewards",pb:Object.assign(Object.assign({},c.Ytw.BadRequestReportingRewardActivity.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(p)} Service url: ${h.href}`})})):500===e.status?f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.UnknownErrorsReportingRewardActivity),{message:"Unknown errors when reporting rewards",pb:Object.assign(Object.assign({},c.Ytw.UnknownErrorsReportingRewardActivity.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(p)} Service url: ${h.href}`})})):f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.UnknownErrorOccurred),{message:"Unknown errors occurred when reporting rewards",pb:Object.assign(Object.assign({},c.Ytw.UnknownErrorOccurred.pb),{customMessage:`Error code: ${e.status} Error message: ${e.statusText}\n                                        Request params: ${JSON.stringify(p)} Service url: ${h.href}`})})),!1)}))),"reportMsRewardsActivity"))}catch(e){return f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.ExceptionReportingRewardActivity),{message:"Exception reporting reward activity",pb:Object.assign(Object.assign({},c.Ytw.ExceptionReportingRewardActivity.pb),{customMessage:`Error code: ${e?e.code:"undefined"} Error message: ${e?e.message:"undefined"}\n                        Request params: ${JSON.stringify(p)} Service url: ${h.href}`})})),!1}}))}reportMsRewardsActivityV2(e,t,r=!1){return(0,s.mG)(this,void 0,void 0,(function*(){const d=new Date,g=(0,i.Yq)();let u;r?(d.setMinutes(d.getMinutes()-480),u=d.toISOString(),u=`${u.substring(0,u.length-1)}0001-08:00`):u=d.toISOString();const l={method:"POST",body:JSON.stringify({activityId:g.ActivityId,eventType:this.eventType,dateTime:u,timezoneOffset:this.getDateTimezoneOffSet(d),market:g.CurrentMarket,pageType:g.TrackInfo&&g.TrackInfo.sitePage&&g.TrackInfo.sitePage.page_type,product:g.TrackInfo&&g.TrackInfo.sitePage&&g.TrackInfo.sitePage.page_product,eventContext:{offerId:e},version:2,activityType:t}),headers:yield n.$.getOneServiceHeaders(),credentials:"include"},p=(0,a.PH)(this.reportRewardsActivityServiceEndpoint);[...n.$.getOneServiceParamsWithAuth(g.UserId,this.ocid)].forEach((e=>{e.value&&p.searchParams.set(e.key,e.value)}));try{return yield(0,o.w)((()=>(0,s.mG)(this,void 0,void 0,(function*(){var e,t;const r=yield fetch(p.href,l);return r.ok?{success:!!r.json(),debugId:null===(t=null==r?void 0:r.headers)||void 0===t?void 0:t.get("ddd-debugid")}:(400===r.status?f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.BadRequestReportingRewardActivity),{message:"Bad request when reporting rewards",pb:Object.assign(Object.assign({},c.Ytw.BadRequestReportingRewardActivity.pb),{customMessage:`Error code: ${r.status} Error message: ${r.statusText}\n                                        Request params: ${JSON.stringify(l)} Service url: ${p.href}`})})):500===r.status?f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.UnknownErrorsReportingRewardActivity),{message:"Unknown errors when reporting rewards",pb:Object.assign(Object.assign({},c.Ytw.UnknownErrorsReportingRewardActivity.pb),{customMessage:`Error code: ${r.status} Error message: ${r.statusText}\n                                        Request params: ${JSON.stringify(l)} Service url: ${p.href}`})})):f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.UnknownErrorOccurred),{message:"Unknown errors occurred when reporting rewards",pb:Object.assign(Object.assign({},c.Ytw.UnknownErrorOccurred.pb),{customMessage:`Error code: ${r.status} Error message: ${r.statusText}\n                                        Request params: ${JSON.stringify(l)} Service url: ${p.href}`})})),{success:!1,debugId:null===(e=null==r?void 0:r.headers)||void 0===e?void 0:e.get("ddd-debugid")})}))),"reportMsRewardsActivityV2")}catch(e){return f.M0.sendAppErrorEvent(Object.assign(Object.assign({},c.Ytw.ExceptionReportingRewardActivity),{message:"Exception reporting reward activity V2",pb:Object.assign(Object.assign({},c.Ytw.ExceptionReportingRewardActivity.pb),{customMessage:`Error code: ${e?e.code:"undefined"} Error message: ${e?e.message:"undefined"}\n                        Request params: ${JSON.stringify(l)} Service url: ${p.href}`})})),{success:!1}}}))}getDateTimezoneOffSet(e){if(!e)return"";let t=e.getTimezoneOffset();const r=t<0?"+":"-";t=Math.abs(t);return`${r}${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`}}},94842:function(){},51167:function(){}}]);